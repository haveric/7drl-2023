"use strict";(self.webpackChunk_7drl_2023=self.webpackChunk_7drl_2023||[]).push([[143],{890:(e,t,s)=>{s.d(t,{Z:()=>r});var n=s(537),o=s.n(n),i=s(645),a=s.n(i)()(o());a.push([e.id,"* {\n    box-sizing: border-box;\n}\n\nbody {\n    margin: 0 auto;\n    overflow: hidden;\n    width: 100vw;\n    height: 100vh;\n    font-size: 1.2vh;\n}\n\n.ui {\n    display: block;\n    z-index: -1000 !important;\n    opacity: 0;\n    pointer-events: none;\n}\n\n.ui.active {\n    z-index: 0 !important;\n    opacity: 1;\n    pointer-events: all;\n}\n\n\n.details {\n    padding: 10px 15px;\n    font-size: 2vh;\n    display: block;\n    width: 20%;\n    position: absolute;\n    top: 0;\n    right: 0;\n    bottom: 0;\n    background-color: #ddd;\n}\n\n.details__header {\n    margin-top: 20px;\n}\n\n.details__line {\n    display: block;\n}\n\n.player-info {\n    height: calc(20vh - 10px);\n    border-bottom: 1px solid #000;\n}\n\n.view-info {\n    height: 30vh;\n    border-bottom: 1px solid #000;\n}\n\n.message-console {\n    position: relative;\n    height: calc(50vh - 10px);\n}\n\n.messages__wrap {\n    position: absolute;\n    opacity: 1;\n    padding: 15px 5px 5px;\n    width: 100%;\n    height: 100%;\n}\n\n.messages {\n    display:flex;\n    flex-direction:column-reverse;\n    height: 100%;\n    overflow-y: scroll;\n}\n\n\n.messages__inn {\n\n}\n\n.message {\n    font-size: 1.66vh;\n}\n\n.message__text {\n\n}\n\n.message__bold {\n    font-weight: bold;\n}\n\n.message__italics {\n    font-style: italic;\n}\n\n.message__amount {\n    margin-left: 1em;\n}\n\n\n.player-health {\n    position: relative;\n    width: 100%;\n    height: 2vh;\n    background-color: #000;\n}\n\n.player-health__fg {\n    position: absolute;\n    top: 0;\n    left: 0;\n    bottom: 0;\n    background-color: #8B0000;\n}\n\n.player-health__text {\n    display: table;\n    position: absolute;\n    left: 0;\n    right: 0;\n    font-size: 1.8vh;\n    color: #fff;\n    margin: 0 auto;\n}\n\n.player-stat {\n    display: inline-block;\n    float: left;\n    width: 50%;\n}","",{version:3,sources:["webpack://./src/styles/style.css"],names:[],mappings:"AAAA;IACI,sBAAsB;AAC1B;;AAEA;IACI,cAAc;IACd,gBAAgB;IAChB,YAAY;IACZ,aAAa;IACb,gBAAgB;AACpB;;AAEA;IACI,cAAc;IACd,yBAAyB;IACzB,UAAU;IACV,oBAAoB;AACxB;;AAEA;IACI,qBAAqB;IACrB,UAAU;IACV,mBAAmB;AACvB;;;AAGA;IACI,kBAAkB;IAClB,cAAc;IACd,cAAc;IACd,UAAU;IACV,kBAAkB;IAClB,MAAM;IACN,QAAQ;IACR,SAAS;IACT,sBAAsB;AAC1B;;AAEA;IACI,gBAAgB;AACpB;;AAEA;IACI,cAAc;AAClB;;AAEA;IACI,yBAAyB;IACzB,6BAA6B;AACjC;;AAEA;IACI,YAAY;IACZ,6BAA6B;AACjC;;AAEA;IACI,kBAAkB;IAClB,yBAAyB;AAC7B;;AAEA;IACI,kBAAkB;IAClB,UAAU;IACV,qBAAqB;IACrB,WAAW;IACX,YAAY;AAChB;;AAEA;IACI,YAAY;IACZ,6BAA6B;IAC7B,YAAY;IACZ,kBAAkB;AACtB;;;AAGA;;AAEA;;AAEA;IACI,iBAAiB;AACrB;;AAEA;;AAEA;;AAEA;IACI,iBAAiB;AACrB;;AAEA;IACI,kBAAkB;AACtB;;AAEA;IACI,gBAAgB;AACpB;;;AAGA;IACI,kBAAkB;IAClB,WAAW;IACX,WAAW;IACX,sBAAsB;AAC1B;;AAEA;IACI,kBAAkB;IAClB,MAAM;IACN,OAAO;IACP,SAAS;IACT,yBAAyB;AAC7B;;AAEA;IACI,cAAc;IACd,kBAAkB;IAClB,OAAO;IACP,QAAQ;IACR,gBAAgB;IAChB,WAAW;IACX,cAAc;AAClB;;AAEA;IACI,qBAAqB;IACrB,WAAW;IACX,UAAU;AACd",sourcesContent:["* {\n    box-sizing: border-box;\n}\n\nbody {\n    margin: 0 auto;\n    overflow: hidden;\n    width: 100vw;\n    height: 100vh;\n    font-size: 1.2vh;\n}\n\n.ui {\n    display: block;\n    z-index: -1000 !important;\n    opacity: 0;\n    pointer-events: none;\n}\n\n.ui.active {\n    z-index: 0 !important;\n    opacity: 1;\n    pointer-events: all;\n}\n\n\n.details {\n    padding: 10px 15px;\n    font-size: 2vh;\n    display: block;\n    width: 20%;\n    position: absolute;\n    top: 0;\n    right: 0;\n    bottom: 0;\n    background-color: #ddd;\n}\n\n.details__header {\n    margin-top: 20px;\n}\n\n.details__line {\n    display: block;\n}\n\n.player-info {\n    height: calc(20vh - 10px);\n    border-bottom: 1px solid #000;\n}\n\n.view-info {\n    height: 30vh;\n    border-bottom: 1px solid #000;\n}\n\n.message-console {\n    position: relative;\n    height: calc(50vh - 10px);\n}\n\n.messages__wrap {\n    position: absolute;\n    opacity: 1;\n    padding: 15px 5px 5px;\n    width: 100%;\n    height: 100%;\n}\n\n.messages {\n    display:flex;\n    flex-direction:column-reverse;\n    height: 100%;\n    overflow-y: scroll;\n}\n\n\n.messages__inn {\n\n}\n\n.message {\n    font-size: 1.66vh;\n}\n\n.message__text {\n\n}\n\n.message__bold {\n    font-weight: bold;\n}\n\n.message__italics {\n    font-style: italic;\n}\n\n.message__amount {\n    margin-left: 1em;\n}\n\n\n.player-health {\n    position: relative;\n    width: 100%;\n    height: 2vh;\n    background-color: #000;\n}\n\n.player-health__fg {\n    position: absolute;\n    top: 0;\n    left: 0;\n    bottom: 0;\n    background-color: #8B0000;\n}\n\n.player-health__text {\n    display: table;\n    position: absolute;\n    left: 0;\n    right: 0;\n    font-size: 1.8vh;\n    color: #fff;\n    margin: 0 auto;\n}\n\n.player-stat {\n    display: inline-block;\n    float: left;\n    width: 50%;\n}"],sourceRoot:""}]);const r=a},645:e=>{e.exports=function(e){var t=[];return t.toString=function(){return this.map((function(t){var s="",n=void 0!==t[5];return t[4]&&(s+="@supports (".concat(t[4],") {")),t[2]&&(s+="@media ".concat(t[2]," {")),n&&(s+="@layer".concat(t[5].length>0?" ".concat(t[5]):""," {")),s+=e(t),n&&(s+="}"),t[2]&&(s+="}"),t[4]&&(s+="}"),s})).join("")},t.i=function(e,s,n,o,i){"string"==typeof e&&(e=[[null,e,void 0]]);var a={};if(n)for(var r=0;r<this.length;r++){var l=this[r][0];null!=l&&(a[l]=!0)}for(var h=0;h<e.length;h++){var c=[].concat(e[h]);n&&a[c[0]]||(void 0!==i&&(void 0===c[5]||(c[1]="@layer".concat(c[5].length>0?" ".concat(c[5]):""," {").concat(c[1],"}")),c[5]=i),s&&(c[2]?(c[1]="@media ".concat(c[2]," {").concat(c[1],"}"),c[2]=s):c[2]=s),o&&(c[4]?(c[1]="@supports (".concat(c[4],") {").concat(c[1],"}"),c[4]=o):c[4]="".concat(o)),t.push(c))}},t}},537:e=>{e.exports=function(e){var t=e[1],s=e[3];if(!s)return t;if("function"==typeof btoa){var n=btoa(unescape(encodeURIComponent(JSON.stringify(s)))),o="sourceMappingURL=data:application/json;charset=utf-8;base64,".concat(n),i="/*# ".concat(o," */");return[t].concat([i]).join("\n")}return[t].join("\n")}},379:e=>{var t=[];function s(e){for(var s=-1,n=0;n<t.length;n++)if(t[n].identifier===e){s=n;break}return s}function n(e,n){for(var i={},a=[],r=0;r<e.length;r++){var l=e[r],h=n.base?l[0]+n.base:l[0],c=i[h]||0,p="".concat(h," ").concat(c);i[h]=c+1;var d=s(p),m={css:l[1],media:l[2],sourceMap:l[3],supports:l[4],layer:l[5]};if(-1!==d)t[d].references++,t[d].updater(m);else{var u=o(m,n);n.byIndex=r,t.splice(r,0,{identifier:p,updater:u,references:1})}a.push(p)}return a}function o(e,t){var s=t.domAPI(t);return s.update(e),function(t){if(t){if(t.css===e.css&&t.media===e.media&&t.sourceMap===e.sourceMap&&t.supports===e.supports&&t.layer===e.layer)return;s.update(e=t)}else s.remove()}}e.exports=function(e,o){var i=n(e=e||[],o=o||{});return function(e){e=e||[];for(var a=0;a<i.length;a++){var r=s(i[a]);t[r].references--}for(var l=n(e,o),h=0;h<i.length;h++){var c=s(i[h]);0===t[c].references&&(t[c].updater(),t.splice(c,1))}i=l}}},569:e=>{var t={};e.exports=function(e,s){var n=function(e){if(void 0===t[e]){var s=document.querySelector(e);if(window.HTMLIFrameElement&&s instanceof window.HTMLIFrameElement)try{s=s.contentDocument.head}catch(e){s=null}t[e]=s}return t[e]}(e);if(!n)throw new Error("Couldn't find a style target. This probably means that the value for the 'insert' parameter is invalid.");n.appendChild(s)}},216:e=>{e.exports=function(e){var t=document.createElement("style");return e.setAttributes(t,e.attributes),e.insert(t,e.options),t}},565:(e,t,s)=>{e.exports=function(e){var t=s.nc;t&&e.setAttribute("nonce",t)}},795:e=>{e.exports=function(e){var t=e.insertStyleElement(e);return{update:function(s){!function(e,t,s){var n="";s.supports&&(n+="@supports (".concat(s.supports,") {")),s.media&&(n+="@media ".concat(s.media," {"));var o=void 0!==s.layer;o&&(n+="@layer".concat(s.layer.length>0?" ".concat(s.layer):""," {")),n+=s.css,o&&(n+="}"),s.media&&(n+="}"),s.supports&&(n+="}");var i=s.sourceMap;i&&"undefined"!=typeof btoa&&(n+="\n/*# sourceMappingURL=data:application/json;base64,".concat(btoa(unescape(encodeURIComponent(JSON.stringify(i))))," */")),t.styleTagTransform(n,e,t.options)}(t,e,s)},remove:function(){!function(e){if(null===e.parentNode)return!1;e.parentNode.removeChild(e)}(t)}}}},589:e=>{e.exports=function(e,t){if(t.styleSheet)t.styleSheet.cssText=e;else{for(;t.firstChild;)t.removeChild(t.firstChild);t.appendChild(document.createTextNode(e))}}},185:(e,t,s)=>{var n=s(379),o=s.n(n),i=s(795),a=s.n(i),r=s(569),l=s.n(r),h=s(565),c=s.n(h),p=s(216),d=s.n(p),m=s(589),u=s.n(m),f=s(890),g={};g.styleTagTransform=u(),g.setAttributes=c(),g.insert=l().bind(null,"head"),g.domAPI=a(),g.insertStyleElement=d(),o()(f.Z,g),f.Z&&f.Z.locals&&f.Z.locals;class v{constructor(e){this.entity=e}perform(){console.error("Not Implemented")}isPlayer(){return this.entity===O.player}}class A extends v{constructor(e){super(e)}perform(){return this}}class y extends v{constructor(e,t){super(e),this.reason=t}perform(){return this}}class x{constructor(e,t,s){this.text=e,this.color=t||"#333",this.bold=!1,this.italics=!1,s&&(this.bold=s.bold||!1,this.italics=s.italics||!1)}isEqual(e){return this.text===e.text&&this.color===e.color&&this.bold===e.bold&&this.italics===e.italics}}class w{constructor(e=[]){this.subMessages=e,this.count=1}isEqual(e){if(this.subMessages.length!==e.length)return!1;for(let t=0;t<this.subMessages.length;t++){const s=this.subMessages[t],n=e[t];if(!s.isEqual(n))return!1}return!0}getHtml(){const e=document.createElement("div");e.classList.add("message");for(const t of this.subMessages){const s=document.createElement("span");s.classList.add("message__text"),t.bold&&s.classList.add("message__bold"),t.italics&&s.classList.add("message__italics"),s.innerText=t.text,s.style.color=t.color,e.appendChild(s)}return this.count>1&&e.appendChild(this.getCountHtml()),e}getCountHtml(){const e=document.createElement("span");return e.classList.add("message__amount"),e.innerText="x"+this.count,e}}class b{constructor(e){this.dom=this.htmlToElement(e)}htmlToElement(e){const t=document.createElement("template");return e=e.trim(),t.innerHTML=e,t.content.firstChild}appendTo(e){e.appendChild(this.dom)}isOpen(){return this.dom.classList.contains("active")}open(){this.dom.classList.contains("active")||this.dom.classList.add("active")}close(){this.dom.classList.remove("active")}}const C=new class extends b{constructor(){super('<div class="ui message-console">\n    <div class="messages__wrap">\n        <div class="messages">\n            <div class="messages__inn"></div>\n        </div>\n    </div>\n</div>'),this.messagesInnerDom=this.dom.getElementsByClassName("messages__inn")[0]}updateLastMessageCount(e){const t=document.querySelectorAll(".message:last-child")[0],s=t.querySelectorAll(".message__amount")[0];s?s.innerText="x"+e.count:t.appendChild(e.getCountHtml())}addMessage(e){this.messagesInnerDom.appendChild(e)}clear(){this.messagesInnerDom.innerHTML=""}},M=new class{constructor(){this.messages=[],this.builder=[]}text(e,t,s){return this.builder.push(new x(e,t,s)),this}build(e=!0){this.addMessage(this.builder.slice(0),e),this.builder=[]}clear(){this.messages=[],C.clear()}addMessage(e,t=!0){if(t&&this.messages.length>0){const t=this.messages[this.messages.length-1];t.isEqual(e)?(t.count+=1,C.updateLastMessageCount(t)):this.addNewMessage(e)}else this.addNewMessage(e)}addNewMessage(e){const t=new w(e);this.messages.push(t),C.addMessage(t.getHtml())}},k=M,I=new class extends b{constructor(){super('<div class="ui view-info">\n\n</div>')}updatePlayerDetails(){const e=O.player.getComponent("position"),t=O.gameMap.tiles[e.x][e.y];this.updatePositionDetails(t)}getDetailsLine(e){return"<span class='details__line'>"+e+"</span>"}updatePositionDetails(e){let t;const s=e.getComponent("fov");t=s&&s.explored?this.getDetailsLine(e.name):this.getDetailsLine("You haven't explored here."),this.dom.innerHTML=t}};class B{constructor(e,t){this.name=e,this.image=t}}class T{constructor(){this.textures=[]}addTexture(e,t){const s=this,n=new Image;n.onload=function(){s.textures.push(new B(e,n))},n.src=t}getTexture(e){const t=this.textures.length;for(let s=0;s<t;s++)if(this.textures[s].name===e)return this.textures[s].image;return null}}class S{constructor(e,t,s,n,o,i){this.imageName=e,this.textureName=t,this.texture=O.textureManager.getTexture(t),this.x=s,this.y=n,this.w=o||64,this.h=i||64}loadTexture(){return null===this.texture&&(this.texture=O.textureManager.getTexture(this.textureName)),null!==this.texture}drawImage(e,t,s,n){null!==n&&n>0?(e.save(),e.translate(t+this.w/2,s+this.h/2),e.rotate(n*Math.PI/180),e.drawImage(this.texture,this.x,this.y,this.w,this.h,-this.w/2,-this.h/2,this.w,this.h),e.restore()):e.drawImage(this.texture,this.x,this.y,this.w,this.h,t,s,this.w,this.h)}}class E{constructor(){this.sprites=[],this.spritesPreloaded=!1}addImage(e,t,s,n,o,i){this.sprites.push(new S(e,t,s,n,o,i))}getImage(e){const t=this.sprites.length;for(let s=0;s<t;s++)if(this.sprites[s].imageName===e)return this.sprites[s];return null}preloadSprites(){if(!this.spritesPreloaded){const e=this.sprites.length;let t=0;this.sprites.forEach((function(e){e.loadTexture()&&t++})),t===e&&(this.spritesPreloaded=!0)}return this.spritesPreloaded}}const _=s.p+"25dbe165d77e35f10dd9.gif",N=s.p+"5c5b2bc2ae027c4c410f.gif",L=s.p+"f5e785405df83d175374.png",P=s.p+"ad367ee8b03fcda8629d.png",D=new class{constructor(){this.eventHandler=null,this.player=null,this.gameMap=null,this.needsRenderUpdate=!1,this.textureManager=null,this.spriteManager=null}initTextures(){this.textureManager=new T,this.textureManager.addTexture("sprites",_),this.textureManager.addTexture("player",N),this.textureManager.addTexture("scribble",L),this.textureManager.addTexture("rltiles",P),this.spriteManager=new E,this.spriteManager.addImage("placeholder","sprites",0,0),this.spriteManager.addImage("floor","scribble",0,0),this.spriteManager.addImage("wall","scribble",128,0),this.spriteManager.addImage("stairs","scribble",448,256),this.spriteManager.addImage("player","scribble",0,512),this.spriteManager.addImage("rat","rltiles",320,640),this.spriteManager.addImage("potion_red","rltiles",640,2688)}handleEvents(){this.processAction(this.eventHandler.handleInput())}processAction(e){if(e&&this.eventHandler.isPlayerTurn){const t=e.perform();return!(t instanceof A||(t instanceof y?(t.reason&&k.text(t.reason).build(),1):(D.needsRenderUpdate=!0,D.player.fov.compute(D.player,5),D.player.fov.updateMap(),I.updatePlayerDetails(),this.handleEnemyTurns(),0)))}}handleEnemyTurns(){this.eventHandler.isPlayerTurn=!1;for(const e of this.gameMap.actors)if(e!==this.player){const t=e.getComponent("ai");t&&t.perform()}this.eventHandler.isPlayerTurn=!0}},O=D;class F{constructor(){this.mouse={x:-1,y:-1},this.mouseDown=!1,window.addEventListener("mousemove",this),window.addEventListener("mousedown",this),window.addEventListener("mouseup",this),window.addEventListener("click",this),window.addEventListener("contextmenu",this),window.addEventListener("change",this),window.addEventListener("keydown",this),this.isPlayerTurn=!0,this.targetedTile=null,this.pathTiles=[]}teardown(){window.removeEventListener("mousemove",this),window.removeEventListener("mousedown",this),window.removeEventListener("mouseup",this),window.removeEventListener("click",this),window.removeEventListener("contextmenu",this),window.removeEventListener("change",this),window.removeEventListener("keydown",this)}handleEvent(e){switch(e.type){case"mousemove":this.onMouseMove(e);break;case"mousedown":this.onMouseDown(e);break;case"mouseup":this.onMouseUp(e);break;case"click":this.onLeftClick(e);break;case"contextmenu":this.onRightClick(e);break;case"change":this.onChange(e);break;case"keydown":this.onKeydown(e)}}handleInput(){}onMouseMove(){}onMouseDown(){this.mouseDown=!0}onMouseUp(){this.mouseDown=!1}onLeftClick(){}onRightClick(){}onChange(){}onKeydown(){}}const H="ArrowLeft",z="ArrowRight",R="ArrowUp",U="ArrowDown",G="Left Shift",q="Right Shift",J="Numpad .",V="Numpad 0",W="Numpad 1",Y="Numpad 2",j="Numpad 3",X="Numpad 4",Z="Numpad 5",K="Numpad 6",Q="Numpad 7",$="Numpad 8",ee="Numpad 9",te="Numpad Delete",se="Numpad Insert",ne="Numpad End",oe="Numpad ArrowDown",ie="Numpad PageDown",ae="Numpad ArrowLeft",re="Numpad Clear",le="Numpad ArrowRight",he="Numpad Home",ce="Numpad ArrowUp",pe="Numpad PageUp",de=new class{constructor(){const e=this;e.defaultDelay=25,e.lastShiftUp=null,e.treatShiftNumpadEqual=!0,e.keysDown=[],e.keysDelayed=[],e.defaults=new Map,e.controls=new Map,e.defaults.set("up",[$,R]),e.defaults.set("down",[Y,U]),e.defaults.set("left",[X,H]),e.defaults.set("right",[K,z]),e.defaults.set("nw",[Q]),e.defaults.set("ne",[ee]),e.defaults.set("sw",[W]),e.defaults.set("se",[j]),e.defaults.set("wait",[Z]),e.load(),addEventListener("keydown",(function(t){"/"===t.key&&t.preventDefault(),e.treatShiftNumpadEqual&&t.getModifierState("NumLock")&&!t.shiftKey&&t.code.startsWith("Numpad")&&t.keyCode<90&&e.lastShiftUp&&(e.keysDown[e.lastShiftUp]=!0);const s=e.getKey(t.key,t.code);e.keysDown[s]=!0}),!1),addEventListener("keyup",(function(t){const s=e.getKey(t.key,t.code);s!==G&&s!==q||(e.lastShiftUp=s),delete e.keysDown[s],delete e.keysDelayed[s]}),!1)}getKey(e,t){if(t.startsWith("Arrow")||(t.endsWith("Left")?e="Left "+e:t.endsWith("Right")?e="Right "+e:t.startsWith("Numpad")&&(e="Numpad "+e)),this.treatShiftNumpadEqual)switch(e){case te:e=J;break;case se:e=V;break;case ne:e=W;break;case oe:e=Y;break;case ie:e=j;break;case ae:e=X;break;case re:e=Z;break;case le:e=K;break;case he:e=Q;break;case ce:e=$;break;case pe:e=ee}return e}load(){const e=localStorage.getItem("controls");e?this.controls=new Map(JSON.parse(e)):this.resetToDefault()}save(){localStorage.setItem("controls",JSON.stringify(Array.from(this.controls.entries())))}setControls(e){this.controls=new Map;for(const[t,s]of e.entries()){const e=[];for(const t of s)e.push(t);this.controls.set(t,e)}this.save()}resetToDefault(){this.setControls(this.defaults)}clone(){const e=new Map;for(const[t,s]of this.controls.entries()){const n=[];for(const e of s)n.push(e);e.set(t,n)}return e}isPressed(e){const t=this;let s=!1,n=t.controls.get(e);if(!n){const s=t.defaults.get(e);s?(t.controls.set(e,s),t.save(),n=s):console.error("Missing keybindings for: ",e,n)}return n.forEach((function(e){e in t.keysDown&&(s=!0)})),s}isDelayed(e){const t=this;let s=!1;return this.controls.get(e).forEach((function(e){e in t.keysDelayed&&(s=!0)})),s}deleteKey(e,t){const s=this;s.controls.get(e).forEach((function(e){delete s.keysDown[e],t&&(s.keysDelayed[e]=!0)})),t&&setTimeout((function(){s.controls.get(e).forEach((function(e){delete s.keysDelayed[e]}))}),t)}testPressed(e,t){t=t||this.defaultDelay;const s=this;let n=!1;return s.isPressed(e)&&!s.isDelayed(e)&&(s.deleteKey(e,t),n=!0),n}};class me extends v{constructor(e,t=0,s=0){super(e),this.dx=t,this.dy=s}perform(){console.error("Not Implemented")}}class ue extends me{constructor(e,t=0,s=0){super(e,t,s)}perform(){const e=this.entity.getComponent("position");if(!e)return new y(this.entity,"Entity doesn't have a position.");const t=e.x+this.dx,s=e.y+this.dy;if(!O.gameMap.isInBounds(t,s))return new y(this.entity,"Location is outside the map!");const n=this.tryMoveTo(t,s);return n instanceof y||e.move(this.dx,this.dy),n}tryMoveTo(e,t){if(O.gameMap.getBlockingActorAtLocation(e,t))return new y(this.entity,"There's something in the way!");const s=O.gameMap.tiles[e][t];if(s){const e=s.getComponent("blocksMovement");if(e&&e.blocksMovement)return new y(this.entity,"There's a "+s.name+" in the way!")}return this}}class fe extends me{constructor(e,t=0,s=0){super(e,t,s)}perform(){const e=this.entity.getComponent("position");if(!e)return new y(this.entity,"Entity doesn't have a position.");const t=e.x+this.dx,s=e.y+this.dy,n=O.gameMap.getBlockingActorAtLocation(t,s);if(!n)return new y(this.entity,"There's nothing to attack there!");{const e=this.entity.getComponent("fighter"),t=n.getComponent("fighter");if(e&&t){let s,o,i,a;this.isPlayer()?(s="You",o=""):(s=this.entity.name,o="s"),n===O.player?(i="You",a="#C00"):(i=n.name,a="#999");const r=s+" attack"+o+" "+i,l=e.power-t.defense;l>0?(C.text(r+" for "+l+" hit points.",a).build(),t.takeDamage(l)):C.text(r+", but does no damage.",a).build(),this.entity.callEvent("onMeleeAttack",n)}}}}class ge extends me{constructor(e,t=0,s=0){super(e,t,s)}perform(){const e=this.entity.getComponent("position");if(!e)return new y(this.entity,"Entity doesn't have a position.");const t=e.x+this.dx,s=e.y+this.dy;return O.gameMap.getBlockingActorAtLocation(t,s)?new fe(this.entity,this.dx,this.dy).perform():O.gameMap.tiles[t]?new ue(this.entity,this.dx,this.dy).perform():new y(this.entity,"Nowhere to move.")}}class ve extends v{constructor(e){super(e)}perform(){return this}}class Ae extends F{constructor(){super()}teardown(){super.teardown()}handleInput(){let e=null;return this.isPlayerTurn&&O.player.isAlive()&&(de.testPressed("up")?e=new ge(O.player,0,-1):de.testPressed("down")?e=new ge(O.player,0,1):de.testPressed("left")?e=new ge(O.player,-1,0):de.testPressed("right")?e=new ge(O.player,1,0):de.testPressed("nw")?e=new ge(O.player,-1,-1):de.testPressed("ne")?e=new ge(O.player,1,-1):de.testPressed("sw")?e=new ge(O.player,-1,1):de.testPressed("se")?e=new ge(O.player,1,1):de.testPressed("wait")&&(e=new ve(O.player))),e}onMouseMove(e){this.mouse.x=e.clientX,this.mouse.y=e.clientY,O.needsRenderUpdate=!0}}class ye{constructor(e={},t,s){this.args=e,this.baseType=t||"component",this.type=s||this.baseType,this.parentEntity=e.parentEntity,this.cachedSave=null}clearSaveCache(){this.cachedSave=null,this.parentEntity?.clearSaveCache()}save(){return null}hasComponent(){return this.args.components&&void 0!==this.args.components[this.type]}isPlayer(){return this.parentEntity===O.player}saveBoolean(e,t){if(this.cachedSave)return this.cachedSave;const s={};return e!==t&&(s[this.type]=e),this.cachedSave=s,s}loadBooleanOrObject(e){const t=typeof this.args.components[this.type];return"boolean"===t?this.args.components[this.type]:"object"===t?this.args.components[this.type][e]:void 0}loadArg(e,t){return this.args.components[this.type][e]||t}loadArgArray(e){const t=[],s=this.args.components[this.type][e].split(",");for(const e of s)t.push(e.trim());return t}}class xe extends ye{constructor(e){super(e,"fov"),this.explored=!1,this.visible=!1,this.hasComponent()&&(this.explored=this.loadArg("explored",!1),this.visible=this.loadArg("visible",!1))}save(){if(this.cachedSave)return this.cachedSave;const e={fov:{}};return!1!==this.explored&&(e.fov.explored=this.explored),!1!==this.visible&&(e.fov.visible=this.visible),this.cachedSave=e,e}setExplored(e){this.explored=e,this.clearSaveCache()}setVisible(e){this.visible=e}}class we{constructor(){this.previousVisibleTiles=[],this.visibleTiles=[],this.visibleActors=[],this.visibleItems=[],this.left=0,this.right=0,this.top=0,this.bottom=0}teardown(){this.previousVisibleTiles=[],this.visibleTiles=[],this.visibleActors=[],this.visibleItems=[]}compute(e,t,s){this.previousVisibleTiles=this.visibleTiles,this.visibleTiles=[],this.visibleActors=[],this.visibleItems=[],this.left=Math.max(0,e-s),this.right=Math.min(O.gameMap.width,e+s+1),this.top=Math.max(0,t-s),this.bottom=Math.min(O.gameMap.height,t+s+1)}addVisibleTile(e){-1===this.visibleTiles.indexOf(e)&&this.visibleTiles.push(e)}addVisibleActor(e){-1===this.visibleActors.indexOf(e)&&this.visibleActors.push(e)}addVisibleItem(e){-1===this.visibleItems.indexOf(e)&&this.visibleItems.push(e)}exploreTile(e,t){const s=O.gameMap.tiles[e];if(s){const e=s[t];e&&this.addVisibleTile(e)}for(const s of O.gameMap.actors){const n=s.getComponent("position");n&&n.x===e&&n.y===t&&this.addVisibleActor(s)}for(const s of O.gameMap.items){const n=s.getComponent("position");n&&n.x===e&&n.y===t&&this.addVisibleItem(s)}}updateMap(){for(const e of this.previousVisibleTiles){const t=e.getComponent("fov");t&&t.setVisible(!1)}for(const e of this.visibleTiles){const t=e.getComponent("fov");t?(t.setExplored(!0),t.setVisible(!0)):e.setComponent(new xe({components:{fov:{explored:!0,visible:!0}}}))}}}class be{constructor(e,t){this.y=e,this.x=t}greater(e,t){return this.y*t>this.x*e}greaterOrEqual(e,t){return this.y*t>=this.x*e}lessOrEqual(e,t){return this.y*t<=this.x*e}}class Ce extends we{constructor(){super()}compute(e,t,s){super.compute(e,t,s),this.exploreTile(e,t);for(let n=0;n<8;n++)this.computeOctant(n,e,t,s,1,new be(1,1),new be(0,1))}computeOctant(e,t,s,n,o,i,a){for(;o<=n;o++){let r,l;if(1===i.x)r=o;else if(r=Math.round(((2*o-1)*i.y+i.x)/(2*i.x)),this.blocksLight(e,t,s,o,r))i.greaterOrEqual(2*r+1,2*o)&&!this.blocksLight(e,t,s,o,r+1)&&r++;else{let n=2*o;this.blocksLight(e,t,s,o+1,r+1)&&n++,i.greater(2*r+1,n)&&r++}0===a.y?l=0:(l=((2*o-1)*a.y+a.x)/(2*a.x),a.greaterOrEqual(2*l+1,2*o)&&this.blocksLight(e,t,s,o,l)&&!this.blocksLight(e,t,s,o,l+1)&&l++);let h=-1;for(let c=r;c>=l;c--){const p=this.blocksLight(e,t,s,o,c);if((p||(c!==r||i.greaterOrEqual(c,o))&&(c!==l||a.lessOrEqual(c,o)))&&this.setVisible(e,t,s,o,c),o!==n)if(p){if(0===h){const r=2*o,h=2*c+1;if(i.greater(h,r)){if(c===l){a=new be(h,r);break}this.computeOctant(e,t,s,n,o+1,i,new be(h,r))}else if(c===l)return}h=1}else{if(h>0){const e=2*o,t=2*c+1;if(a.greaterOrEqual(t,e))return;i=new be(t,e)}h=0}}if(0!==h)break}}blocksLight(e,t,s,n,o){switch(e){case 0:t+=n,s-=o;break;case 1:t+=o,s-=n;break;case 2:t-=o,s-=n;break;case 3:t-=n,s-=o;break;case 4:t-=n,s+=o;break;case 5:t-=o,s+=n;break;case 6:t+=o,s+=n;break;case 7:t+=n,s+=o}let i=!1;const a=O.gameMap.tiles;if(a[t]){const e=a[t][s];if(e){const t=e.getComponent("blocksFov");t&&(i=t.blocksFov)}}return i}setVisible(e,t,s,n,o){switch(e){case 0:t+=n,s-=o;break;case 1:t+=o,s-=n;break;case 2:t-=o,s-=n;break;case 3:t-=n,s-=o;break;case 4:t-=n,s+=o;break;case 5:t-=o,s+=n;break;case 6:t+=o,s+=n;break;case 7:t+=n,s+=o}this.exploreTile(t,s)}}class Me{constructor(){}static extend(e){e=e||{};for(let t=1;t<arguments.length;t++)if(arguments[t])for(const s in arguments[t])Object.prototype.hasOwnProperty.call(arguments[t],s)&&(e[s]=arguments[t][s]);return e}static deep(e){e=e||{};for(let t=1;t<arguments.length;t++){const s=arguments[t];if(s)for(const t in s)Object.prototype.hasOwnProperty.call(s,t)&&("object"==typeof s[t]?s[t]instanceof Array?e[t]=s[t].slice(0):e[t]=Me.deep(e[t],s[t]):"boolean"==typeof e&&void 0===e[t]?e=s[t]:e[t]=s[t])}return e}}class ke extends ye{constructor(e={},t){super(e,"ai",t)}save(){return super.save()}perform(){console.error("Not Implemented")}}class Ie extends ke{constructor(e={}){super(e,"aiDead"),this.previousAI="",this.hasComponent()&&(this.previousAI=this.loadArg("previousAI",""))}save(){if(this.cachedSave)return this.cachedSave;const e={aiDead:{}};return e.aiDead.previousAI=this.previousAI,this.cachedSave=e,e}perform(){}}class Be extends ye{constructor(e={}){super(e,"blocksFov"),this.blocksFov=!1,this.hasComponent()&&(this.blocksFov=this.loadBooleanOrObject("blocksFov"))}save(){return this.saveBoolean(this.blocksFov,!1)}}class Te extends ye{constructor(e={}){super(e,"blocksMovement"),this.blocksMovement=!1,this.hasComponent()&&(this.blocksMovement=this.loadBooleanOrObject("blocksMovement"))}save(){return this.saveBoolean(this.blocksMovement,!1)}onEntityDeath(){this.blocksMovement=!1,this.clearSaveCache()}}class Se extends ye{constructor(e={}){super(e,"faction"),this.factions=[],this.enemies=[],this.hasComponent()&&(this.factions=this.loadArgArray("factions"),this.enemies=this.loadArgArray("enemies"))}save(){if(this.cachedSave)return this.cachedSave;const e={faction:{}};return e.faction.factions=this.factions.toString(),e.faction.enemies=this.enemies.toString(),this.cachedSave=e,e}isEnemyOf(e){if(!e)return!1;for(const t of this.factions)if(e.enemies.indexOf(t)>-1)return!0;return!1}}const Ee=new class extends b{constructor(){super('<div class="ui player-info">\n    <div class="player-health">\n        <div class="player-health__fg"></div>\n        <div class="player-health__text"></div>\n    </div>\n    <div class="player-stats">\n        <div class="player-stat">Power: <span class="player-power"></span></div>\n        <div class="player-stat">Defense: <span class="player-defense"></span></div>\n    </div>\n</div>'),this.healthFgDom=this.dom.getElementsByClassName("player-health__fg")[0],this.healthTextDom=this.dom.getElementsByClassName("player-health__text")[0],this.powerDom=this.dom.getElementsByClassName("player-power")[0],this.defenseDom=this.dom.getElementsByClassName("player-defense")[0]}updateHealth(e,t){const s=e/t*100;this.healthFgDom.style.width=s+"%",this.healthTextDom.innerText="HP: "+e+" / "+t}updatePower(e){this.powerDom.innerText=e}updateDefense(e){this.defenseDom.innerText=e}};class _e extends ye{constructor(e){super(e,"fighter"),this.hp=0,this.maxHp=0,this.defense=0,this.power=0,this.hasComponent()&&(this.hp=this.loadArg("hp",0),this.maxHp=this.loadArg("maxHp",0),this.defense=this.loadArg("defense",0),this.power=this.loadArg("power",0))}save(){if(this.cachedSave)return this.cachedSave;const e={fighter:{}};return e.fighter.hp=this.hp,e.fighter.maxHp=this.maxHp,e.fighter.defense=this.defense,e.fighter.power=this.power,this.cachedSave=e,e}setHp(e){this.hp=Math.max(0,Math.min(e,this.maxHp)),this.updateUI(),this.clearSaveCache()}heal(e){if(this.hp===this.maxHp)return 0;const t=Math.min(this.maxHp,this.hp+e),s=t-this.hp;return this.setHp(t),s}takeDamage(e){this.setHp(this.hp-e),this.hp<=0&&this.die()}die(){const e=this.parentEntity;this.isPlayer()?k.text("You died!","#f00").build():k.text(e.name+" dies!","#ffa030").build(),e.callEvent("onEntityDeath");const t=e.getComponent("ai");if(t){const s={components:{aiDead:{previousAI:t.type}}};e.removeComponent("ai"),e.setComponent(new Ie(s))}this.clearSaveCache()}updateUI(){this.isPlayer()&&(Ee.updateHealth(this.hp,this.maxHp),Ee.updatePower(this.power),Ee.updateDefense(this.defense))}}class Ne extends ye{constructor(e={}){super(e,"position"),this.x=0,this.y=0,this.hasComponent()&&(this.x=this.loadArg("x",0),this.y=this.loadArg("y",0))}save(){if(this.cachedSave)return this.cachedSave;const e={position:{}};return e.position.x=this.x,e.position.y=this.y,this.cachedSave=e,e}moveTo(e,t){this.x=e,this.y=t,this.clearSaveCache()}move(e,t){this.x+=e,this.y+=t,this.clearSaveCache()}setX(e){this.x=e,this.clearSaveCache()}setY(e){this.y=e,this.clearSaveCache()}}const Le=new class{constructor(){this.types=new Map,this.init()}init(){this.load(new Ie),this.load(new Be),this.load(new Te),this.load(new Se),this.load(new _e),this.load(new xe),this.load(new Ne)}load(e){this.types.set(e.type,e)}create(e,t,s){return new(0,this.types.get(t).constructor)(s)}},Pe=new class extends b{constructor(){super('<div class="ui details"></div>')}updatePlayerDetails(){}getPosition(e){const t=e.getComponent("position");return"<span class='details__line'>Looking at: X:"+t.x+" - Y:"+t.y+"</span>"}updatePositionOnly(e){this.dom.innerHTML=this.getPosition(e)}updatePositionDetails(e,t=!1){if(!e)return;const s=e.getComponent("position"),n=s.x,o=s.y,i=s.z;let a=i-1;e!==O.player&&(a=i);let r=this.getPosition(e);const l=O.gameMap.tiles;for(let e=a;e<=i;e++)if(l.get(e)&&l.get(e)[n]){const t=l.get(e)[n][o];t&&(r+="<span class='details__line'>"+t.name+"</span>")}for(const e of O.gameMap.actors){if(t&&e===O.player)continue;const s=e.getComponent("position");s&&n===s.x&&o===s.y&&(r+="<span class='details__line'><span style='color:"+s.color+"'>"+s.letter+"</span>: "+e.name,r+="</span>")}const h=[];for(const e of O.gameMap.items){const t=e.getComponent("position");t&&n===t.x&&o===t.y&&h.push("<span class='details__line'><span style='color:"+t.color+"'>"+t.letter+"</span>: "+e.name+"</span>")}h.length>0&&(r+="<span class='details__line details__header'>Items:</span>");for(const e of h)r+=e;this.dom.innerHTML=r}},De=new class{constructor(){this.setupGameHtml(),this.resizeCanvas(),window.addEventListener("resize",this)}setupGameHtml(){const e=document.createElement("div");e.classList.add("game"),this.canvas=document.createElement("canvas"),this.canvas.classList.add("view"),e.appendChild(this.canvas),Ee.open(),I.open(),C.open(),Pe.open(),Ee.appendTo(Pe.dom),I.appendTo(Pe.dom),C.appendTo(Pe.dom),Pe.appendTo(e),document.body.appendChild(e),this.ctx=this.canvas.getContext("2d")}handleEvent(e){"resize"===e.type&&this.resizeCanvas()}resizeCanvas(){this.canvas.width=.8*window.innerWidth,this.canvas.height=window.innerHeight,O.needsRenderUpdate=!0}clearAll(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height)}};class Oe{constructor(e){this.args=e,this.type=e.type||"entity",this.id=e.id,this.name=e.name||"",this.description=e.description||"",this.sprite=e.sprite||"",this.letter=e.letter||"?",this.color=e.color||"#fff",this.componentArray=[],this.components={},e.components&&(this.loadComponents(e,e.components),this.callEvent("onComponentsLoaded")),this.cachedSave=null}clone(){console.error("Not implemented")}callEvent(e,t){for(const s of this.componentArray)s[e]?.(t);this[e]?.(t)}draw(){const e=this.getComponent("position");e&&O.spriteManager.getImage(this.sprite).drawImage(De.ctx,64*e.x,64*e.y)}loadComponents(e,t){const s=this;Object.keys(t).forEach((function(t){const n=Le.types.get(t);if(n){const o=n.baseType;s.getComponent(o)||s.setComponent(Le.create(this,t,e),!1)}}))}setComponent(e){e.parentEntity=this,this.components[e.baseType]=e,this.componentArray.push(e)}getComponent(e){return this.components[e]}removeComponent(e){if(this.components[e]){this.components[e]=void 0;for(const t of this.componentArray)if(t.baseType===e){const e=this.componentArray.indexOf(t);this.componentArray.splice(e,1);break}}}clearSaveCache(){this.cachedSave=null}save(){if(null!==this.cachedSave)return this.cachedSave;const e={id:this.id,type:this.type,name:this.name,description:this.description,sprite:this.sprite,letter:this.letter,color:this.color,components:{}};for(const t of this.componentArray){const s=t.save();null!==s&&s!=={}&&Me.deep(e.components,s)}return this.cachedSave=e,e}loadArg(e,t){return this.args[e]||t}}class Fe extends Oe{constructor(e={}){e.type="actor",super(e),this.fov=new Ce}clone(){return new Fe(this.save())}isAlive(){const e=this.getComponent("fighter");return e&&e.hp>0}}class He extends Oe{constructor(e={}){e.type="tile",super(e)}clone(){return new He(this.save())}save(){return super.save()}isWall(){return this.getComponent("blocksMovement")?.blocksMovement}}const ze=JSON.parse('[{"id":"base_actor","type":"actor","sprite":"placeholder","components":{"blocksMovement":true,"fighter":{}}}]'),Re=JSON.parse('[{"id":"rat","extends":"base_actor","name":"Rat","sprite":"rat","components":{"faction":{"factions":"monsters","enemies":"player"},"aiMeleeChase":{"radius":3,"movementActions":2},"fighter":{"baseHp":10,"baseDamage":2},"level":{"xpGiven":10}}}]'),Ue=JSON.parse('[{"id":"player","extends":"base_actor","name":"Player","color":"#00f","letter":"@","sprite":"player","components":{"faction":{"factions":"player","enemies":"monsters"},"fighter":{"hp":30,"maxHp":30,"defense":2,"power":5}}}]'),Ge=JSON.parse('[{"id":"base_tile","type":"tile","sprite":"placeholder","components":{"blocksMovement":true,"blocksFov":true}}]'),qe=JSON.parse('[{"id":"base_floor","extends":"base_tile","components":{"blocksMovement":false,"blocksFov":false}},{"id":"floor","extends":"base_floor","name":"Floor","color":"#ddd","sprite":"floor"}]'),Je=JSON.parse('[{"id":"stairs","extends":"base_tile","sprite":"stairs","components":{"blocksMovement":false,"blocksFov":false}}]'),Ve=JSON.parse('[{"id":"base_wall","extends":"base_tile","components":{"blocksMovement":true,"blocksFov":true}},{"id":"wall","extends":"base_wall","name":"Wall","color":"#666","sprite":"wall"}]'),We=JSON.parse('[{"id":"base_item","type":"item","sprite":"placeholder","components":{}}]'),Ye=JSON.parse('[{"id":"potion","extends":"base_item","maxStackSize":20,"components":{}},{"id":"potion_health","extends":"potion","sprite":"potion_red","name":"Health Potion","description":"Recover a minor amount of health","components":{"healingConsumable":{"amount":4}}}]');class je extends Oe{constructor(e={}){e.type="item",super(e),this.amount=this.loadArg("amount",1),this.maxStackSize=this.loadArg("maxStackSize",1)}save(){const e=super.save();return 1!==this.amount&&(e.amount=this.amount),1!==this.maxStackSize&&(e.maxStackSize=this.maxStackSize),e}clone(){return new je(this.save())}setAmount(e){this.amount=e,this.clearSaveCache()}}const Xe=new class{constructor(){this.types=new Map,this.templates=new Map,this.init()}init(){this.load(new Fe),this.load(new He),this.load(new je),this.loadTemplates()}load(e){this.types.set(e.type,e)}create(e,t={}){let s;if(s="object"==typeof e?e:JSON.parse(e),void 0!==s.extends){if(this.templates.has(s.extends)){const e=JSON.parse(this.templates.get(s.extends));return delete s.extends,this.create(Me.deep(e,s),t)}console.error("Json template for id '"+s.extends+"' is missing. Cannot extend from it.")}return new(this.types.get(s.type).constructor)(Me.deep(s,t))}createFromTemplate(e,t={}){return this.templates.has(e)?this.create(this.templates.get(e),t):(console.error("Json template for id '"+e+"' is missing."),null)}loadTemplate(e){for(const t of e){const e=t.id;this.templates.has(e)?console.error("Template for entity id '"+e+"' already exists."):this.templates.set(e,JSON.stringify(t))}}loadTemplates(){this.loadTemplate(ze),this.loadTemplate(Re),this.loadTemplate(Ue),this.loadTemplate(Ge),this.loadTemplate(qe),this.loadTemplate(Je),this.loadTemplate(Ve),this.loadTemplate(We),this.loadTemplate(Ye)}};class Ze{constructor(){}static create2dArray(e){const t=[];for(let s=0;s<e;s++)t[s]=[];return t}}class Ke{constructor(e,t,s){this.name=e,this.width=t,this.height=s,this.timeout=null,this.saveCache=null,this.init()}init(){this.tiles=Ze.create2dArray(this.width),this.actors=[],this.items=[]}create(){}teardown(){this.timeout&&clearTimeout(this.timeout),O.player.fov.teardown();for(let e=0;e<this.width;e++)for(let t=0;t<this.height;t++){const s=this.tiles[e][t];s&&s.callEvent("onMapTeardown")}for(const e of this.actors)e.callEvent("onMapTeardown");for(const e of this.items)e.callEvent("onMapTeardown")}removeEntity(e){e instanceof Fe?this.removeActor(e):e instanceof je&&this.removeItem(e)}removeItem(e){const t=this.items.indexOf(e);t>-1&&this.items.splice(t,1)}addItem(e,t){const s=e.getComponent("position");t||(t=s);let n=e.amount;for(const o of this.items)if(o.id===e.id){const i=o.getComponent("position");if(i&&t.isSamePosition(i)){if(-1===o.maxStackSize)return o.setAmount(o.amount+e.amount),s.teardown(),!1;const t=o.maxStackSize-o.amount;if(t>=n)return o.setAmount(o.amount+n),s.teardown(),!1;o.setAmount(o.amount+t),e.setAmount(e.amount-t),n-=t}}return n>0?(e.setAmount(n),s.moveTo(t.x,t.y),e.parent=null,this.items.push(e),s.setVisible(),!0):(s.teardown(),!1)}removeActor(e){const t=this.actors.indexOf(e);t>-1&&this.actors.splice(t,1)}save(){if(O.gameMap!==this&&this.saveCache)return this.saveCache;const e={name:this.name,width:this.width,height:this.height,tiles:{}},t=[],s=[];let n="",o=65;for(let e=0;e<this.width;e++)for(let i=0;i<this.height;i++){const a=this.tiles[e][i];if(a){const e=JSON.stringify(a.save()),i=t.indexOf(e);i>-1?n+=s[i]:(t.push(e),s.push(String.fromCharCode(o)),n+=String.fromCharCode(o),o++)}else n+=" "}e.tiles={},e.tiles.key=n,e.tiles.map={};for(let n=0;n<t.length;n++)e.tiles.map[s[n]]=t[n];const i=[];for(const e of this.actors)i.push(JSON.stringify(e.save()));e.actors=i;const a=[];for(const e of this.items)a.push(JSON.stringify(e.save()));return e.items=a,this.saveCache=e,e}load(e){const t=e.tiles;for(let e=0;e<this.width;e++)for(let s=0;s<this.height;s++){const n=t[e*this.height+s];n&&(t[e][s]=Xe.create(n,{components:{position:{x:e,y:s}}}))}const s=e.actors;for(const e of s){const t=Xe.create(e);this.actors.push(t)}const n=e.items;for(const e of n){const t=Xe.create(e);this.items.push(t)}}isInBounds(e,t){return 0<=e&&e<this.width&&0<=t&&t<this.height}revealFromPosition(e,t,s,n=25){const o=this,i=Math.max(0,e-s),a=Math.min(O.gameMap.width,e+s),r=Math.max(0,t-s),l=Math.min(O.gameMap.height,t+s);0===n?o._revealGradually(i,a,r,l,e,t,1,s,n):o.timeout=setTimeout((function(){o._revealGradually(i,a,r,l,e,t,1,s,n)}),n)}_revealGradually(e,t,s,n,o,i,a,r,l){const h=this;h.timeout=null,a<=r&&(h.timeout=setTimeout((function(){h._revealGradually(e,t,s,n,o,i,a+1,r,l)}),l));const c=o-a,p=o+a,d=i-a,m=i+a;for(let e=c;e<=p;e++){const t=e===c||e===p;for(let s=d;s<=m;s++)(t||s===d||s===m)&&(this._revealAtPosition(e,s),O.needsMapUpdate=!0)}return!0}_revealAtPosition(e,t){if(this.tiles[1][e]){const s=this.tiles[1][e][t];s&&s.getComponent("position")&&(s.getComponent("fov")||s.setComponent(new xe({components:{fov:{explored:!0,visible:!1}}})))}}getAliveActorAtLocation(e,t){let s=null;for(const n of this.actors)if(n.isAlive()){const o=n.getComponent("position");if(o&&e===o.x&&t===o.y){s=n;break}}return s}getBlockingActorAtLocation(e,t){let s=null;for(const n of this.actors){const o=n.getComponent("position");if(o&&e===o.x&&t===o.y){const e=n.getComponent("blocksMovement");if(e&&e.blocksMovement){s=n;break}}}return s}addPlayer(e,t){O.player||(O.player=Xe.createFromTemplate("player")),this.actors.push(O.player),O.player.getComponent("position").moveTo(e,t),this.updatePlayerUI()}updatePlayerUI(){Pe.updatePlayerDetails()}draw(){const e=O.gameMap.tiles;for(let t=0;t<e.length;t++){const s=e[t];for(let e=0;e<s.length;e++){const t=s[e];t&&t.draw()}}for(const e of O.gameMap.actors)e.draw();for(const e of O.gameMap.items)e.draw()}}class Qe{constructor(){}static randomInt(e,t){return Math.floor(Math.random()*(t-e+1)+e)}static randomNumber(e,t){return Math.random()*(t-e)+e}}class $e{constructor(){}placeEntities(){}}const et=[],tt=JSON.parse('[{"id":"potion","items":[{"id":"potion_health","weight":30}]}]'),st=JSON.parse('[{"level":1,"actors":[{"id":"rat","weight":50}],"items":[{"group":"potion","weight":50}]}]'),nt=new class{constructor(){this.entityGroups=new Map,this.itemGroups=new Map,this.generators=new Map,this.loadEntityGroups(et),this.loadItemGroups(tt),this.loadGenerator("basic-dungeon",st)}loadEntityGroups(e){for(const t of e)this.entityGroups.set(t.id,t.entities)}loadItemGroups(e){for(const t of e)this.itemGroups.set(t.id,t.items)}loadGenerator(e,t){this.generators.set(e,t)}getChancesForLevel(e,t){let s;const n=this.generators.get(e);for(const e of n){if(e.level>t)break;s=e}return s}getActorForLevel(e,t){const s=this.getChancesForLevel(e,t).actors;let n=this.getRandomFromGroup(s);for(;void 0!==n.group;){const e=this.entityGroups.get(n.group);n=this.getRandomFromGroup(e)}return n.id}getItemForLevel(e,t){const s=this.getChancesForLevel(e,t).items;let n=this.getRandomFromGroup(s);for(;void 0!==n.group;){const e=this.itemGroups.get(n.group);n=this.getRandomFromGroup(e)}return n.id}getRandomFromGroup(e){let t,s=0;for(const t of e)s+=t.weight;let n=0;const o=Qe.randomNumber(0,s);for(const s of e)if(n+=s.weight,o<n){t=s;break}return t}};class ot extends $e{constructor(e,t,s,n){super(),this.x1=e,this.y1=t,this.x2=e+s,this.y2=t+n,this.width=s,this.height=n}getCenterX(){return Math.round((this.x1+this.x2)/2)}getCenterY(){return Math.round((this.y1+this.y2)/2)}intersects(e){return this.x1<=e.x2&&this.x2>=e.x1&&this.y1<=e.y2&&this.y2>=e.y1}createRoom(e){const t=Math.max(0,this.x1),s=Math.min(e.width,this.x2+1),n=Math.max(0,this.y1),o=Math.min(e.height,this.y2+1),i=Xe.createFromTemplate("floor",{components:{position:{x:0,y:0}}}),a=Xe.createFromTemplate("wall",{components:{position:{x:0,y:0}}});for(let r=t;r<s;r++)for(let t=n;t<o;t++){const s=i.clone();s.getComponent("position").moveTo(r,t),e.tiles[r][t]=s;const n=(r===this.x1||r===this.x2)&&t>=this.y1&&t<=this.y2,o=(t===this.y1||t===this.y2)&&r>=this.x1&&r<=this.x2,l=e.tiles[r][t];if((o||n)&&!l){const s=a.clone();s.getComponent("position").moveTo(r,t),e.tiles[r][t]=s}}}placeEntities(e,t,s){const n=Qe.randomInt(0,s);for(let s=0;s<n;s++){const s=Qe.randomInt(this.x1+1,this.x2-1),n=Qe.randomInt(this.y1+1,this.y2-1);if(!O.gameMap.getBlockingActorAtLocation(s,n,1)){const o={components:{position:{x:s,y:n}}},i=nt.getActorForLevel(e,t),a=Xe.createFromTemplate(i,o);O.gameMap.actors.push(a)}}}placeItems(e,t,s){const n=Qe.randomInt(0,s);for(let s=0;s<n;s++){const s={components:{position:{x:Qe.randomInt(this.x1+1,this.x2-1),y:Qe.randomInt(this.y1+1,this.y2-1)}}},n=nt.getItemForLevel(e,t),o=Xe.createFromTemplate(n,s);O.gameMap.items.push(o)}}}class it extends Ke{constructor(e,t,s={}){const n=s.level||1;super("basic-dungeon-"+n,e,t),this.maxRooms=s.maxRooms||6,this.roomMinSize=s.roomMinSize||8,this.roomMaxSize=s.roomMaxSize||8,this.level=n,this.maxMonstersByFloor=[{level:1,amount:2},{level:4,amount:3},{level:7,amount:4}],this.maxItemsByFloor=[{level:1,amount:2},{level:4,amount:3},{level:6,amount:5}]}getFloorAmount(e){let t=0;for(const s of e){if(s.level>this.level)break;t=s.amount}return t}save(){if(O.gameMap!==this&&this.saveCache)return this.saveCache;const e=super.save();return 1!==this.level&&(e.level=this.level),this.saveCache=e,e}create(e,t){super.create();const s=Xe.createFromTemplate("wall",{components:{position:{x:0,y:0}}});for(let e=0;e<this.height;e++)for(let t=0;t<this.width;t++){const n=s.clone();n.getComponent("position").moveTo(t,e),this.tiles[t][e]=n}const n=[];for(let e=0;e<this.maxRooms;e++){const s=Qe.randomInt(this.roomMinSize,this.roomMaxSize),o=Qe.randomInt(this.roomMinSize,this.roomMaxSize);let i=10*e+1,a=1;e>=this.maxRooms/2&&(a=11,i-=30);const r=new ot(i,a,s,o);let l=!1;for(const e of n)if(r.intersects(e)){l=!0;break}if(!l){if(r.createRoom(this),0===n.length){const e=r.getCenterX(),s=r.getCenterY();t&&t.setPosition(e,s,1),this.tiles[e][0]=Xe.createFromTemplate("stairs",{components:{position:{x:e,y:0}}}),this.addPlayer(e,s)}n.push(r)}}for(const e of n)e.placeEntities("basic-dungeon",this.level,this.getFloorAmount(this.maxMonstersByFloor)),e.placeItems("basic-dungeon",this.level,this.getFloorAmount(this.maxItemsByFloor))}}!function(){function e(){O.handleEvents(),O.spriteManager.preloadSprites()&&O.needsRenderUpdate&&(De.clearAll(),O.gameMap.draw(),O.needsRenderUpdate=!1),window.requestAnimationFrame(e)}!function(){O.gameMap=new it(31,21),O.initTextures(),O.player=Xe.createFromTemplate("player",{components:{position:{x:0,y:0}}}),O.gameMap.create(),O.gameMap.actors.push(O.player),O.eventHandler=new Ae,I.updatePlayerDetails(),k.text("Welcome to the dungeon.").build(),O.needsRenderUpdate=!0;const t=O.player.getComponent("position");O.gameMap.revealFromPosition(t.x,t.y,100,0),O.player.fov.compute(t.x,t.y,5),O.player.fov.updateMap(),window.requestAnimationFrame(e)}()}()}},e=>{e(e.s=185)}]);
//# sourceMappingURL=app.1a2989e936d89c5571f6.js.map